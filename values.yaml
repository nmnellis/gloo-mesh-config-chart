# Default values for gloo-mesh-config.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

virtualMesh:
  name: gloo-mesh
  # selecting Istio ingress gateways that will be used for multi-cluster traffic
  eastwestGatewaySelector:
    labels:
      istio: ingressgateway
    namespaces:
      - istio-system
    portName: tls
  # Certificate provisioning
  certificateManagement:
    istioCACerts:
      # Autogenerate Root CA and issue Intermedite CA Certificates to Istio clusters
      autoGenerated: true
      # Restart all service mesh services when Istio CA is rotated
      autoRestartPods: true
      # Optional: Provide your own root CA Certificate
      customCASecretName: istios-ca
  global:
    # Enable default deny to all mesh services
    defaultDenyAccessPolicy: false
    # Enable tcp keep alive for all multi cluster destinations
    tcpKeepAlive:
      enabled: true
      time: 4m
      interval: 1m

clusters:
  - name: cluster1
    #  istio:
    #    namespace: istio-system
    #    revision: 10-0-2
  - name: cluster2

virtualDestinations:

gateways:
  - name: some
    # must match the ingress gateway kubernetes service port name
    portName: http2
    # select which istio ingress gateways this applies to
    selectors:
      - match:
          labels:
            istio: ingressgateway-frontend
          namespaces:
          - istio-system
    hosts:
      - domains:
        - "nick.local"
        match:
        - matches:
          - uri:
              prefix: /frontend
          destinations:
            # - kubeService:
            #     clusterName: cluster1
            #     name: frontend
            #     namespace: frontend
            #     port: 80
            - virtualDestination:      # proxy requests to the frontend VirtualDestination
                name: frontend
                namespace: gloo-mesh

accessPolicies:
  - name: ingress-to-frontend
    sourceServiceAccounts:
      - name: istio-ingressgateway-service-account
        namespace: istio-system
        clusterName: cluster1
      - name: istio-ingressgateway-service-account
        namespace: istio-system
        clusterName: cluster2
    destinationServices:
      - match:
          namespaces:
          - apps
          labels:
            service: wine
      - exact:
          name: frontend
          namespace: frontend
          cluster: cluster1